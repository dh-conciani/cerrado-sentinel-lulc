var wetland_to_savanna = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-46.8130900251511, -10.304770638995485],
           [-46.814634977543676, -10.311695155569497],
           [-46.8105151044968, -10.316592892437288],
           [-46.80279034253391, -10.319632828716195],
           [-46.793692289555395, -10.323686031402941],
           [-46.78974407788547, -10.325881494385195],
           [-46.78665417310032, -10.321828319987027],
           [-46.780989347660864, -10.323686031402941],
           [-46.770003019535864, -10.324023795936187],
           [-46.755240141117895, -10.326894779822966],
           [-46.74511211987766, -10.32655701837318],
           [-46.73841732617649, -10.323517149000306],
           [-46.739275633061254, -10.314228477255112],
           [-46.74030560132297, -10.305277316100607],
           [-46.739790617192114, -10.297677074002292],
           [-46.741507230961645, -10.290921149465916],
           [-46.74665707227024, -10.290245549055488],
           [-46.74888867017063, -10.2845028871806],
           [-46.74734371777805, -10.279266839739138],
           [-46.7416788923386, -10.278253401177125],
           [-46.74837368603977, -10.27048359756531],
           [-46.75678509351047, -10.269132307878545],
           [-46.76468151685032, -10.276564329683676],
           [-46.78133267041477, -10.285178499881914],
           [-46.80261868115696, -10.293623536642546],
           [-46.808455167973364, -10.310006263123517]]],
         [[[-48.10459614765039, -15.738202292742303],
           [-48.10631276141992, -15.746628643182568],
           [-48.11103344928613, -15.76926240312787],
           [-48.08820248615137, -15.761745631306038],
           [-48.08365345966211, -15.76009355622834],
           [-48.08468342792383, -15.752989480216163],
           [-48.08107853900781, -15.750759079514564],
           [-48.08210850726953, -15.747454737166441],
           [-48.08219433795801, -15.744893834885028],
           [-48.080048570746094, -15.742085066243947],
           [-48.07258130084863, -15.736963094099956],
           [-48.07661534320703, -15.735641273890518],
           [-48.080477724188476, -15.733741142286565],
           [-48.0833101369082, -15.732254070386865],
           [-48.08682919513574, -15.731180067253158],
           [-48.088717470282226, -15.732336685777641],
           [-48.097729692572265, -15.732419301134865]]],
         [[[-48.05867672931543, -15.74055381452541],
           [-48.06734562885156, -15.74402349040388],
           [-48.06519986163965, -15.749227893154876],
           [-48.06374073993555, -15.75319306291443],
           [-48.0609941579043, -15.761205773849888],
           [-48.058075914496094, -15.774834916365466],
           [-48.04537297260156, -15.769052967709847],
           [-48.04811955463281, -15.753688703692065],
           [-48.054814348333984, -15.744188711587377]]],
         [[[-48.03100664996243, -15.734508712028324],
           [-48.046584919920925, -15.730791025923555],
           [-48.05018980883694, -15.74256346542574],
           [-48.04242213152981, -15.749172255468762],
           [-48.03323824786282, -15.748139646192843]]],
         [[[-48.058496274057454, -15.731426609817909],
           [-48.067851876092654, -15.72729576258173],
           [-48.07308757057574, -15.729609049798231],
           [-48.06948266911773, -15.73373985158097],
           [-48.05841044284468, -15.732004922724332],
           [-48.06047039191359, -15.734813847743785]]],
         [[[-48.026271612505525, -15.597371470942118],
           [-48.046270162920564, -15.612830172030964],
           [-48.046270162920564, -15.62060041590615],
           [-48.03966119990787, -15.628866309367798],
           [-48.038030416826814, -15.635644093092198],
           [-48.02961900935611, -15.639611472134419],
           [-48.0168302367731, -15.638454327857225],
           [-48.015027792315095, -15.635561438544483],
           [-48.011766226152986, -15.636883907303167],
           [-48.00996378169498, -15.636057365330164],
           [-48.01022127376041, -15.633329753142476],
           [-48.01339700923404, -15.631263356081597],
           [-48.01562860713443, -15.630354134768748],
           [-48.01931932673892, -15.62961022341934],
           [-48.0219800780817, -15.628948966618067],
           [-48.0219800780817, -15.627213157357197],
           [-48.01992014155826, -15.625229357332987],
           [-48.01768854365787, -15.621922981270405],
           [-48.01365450129947, -15.621675000914806],
           [-48.01588609919986, -15.61638468184483],
           [-48.015542776445955, -15.609275600594094],
           [-48.01966264949283, -15.608366281725045],
           [-48.023267538408845, -15.60464629891724],
           [-48.022495062212556, -15.600678242903472],
           [-48.02446916804752, -15.597619480687378]]],
         [[[-47.892784597264296, -15.730660555838448],
           [-47.92093706308461, -15.74833962299243],
           [-47.93810320077992, -15.77080799282421],
           [-47.949947835789686, -15.79955066104203],
           [-47.96488237558461, -15.819535974196851],
           [-47.95183611093617, -15.84084045514746],
           [-47.937244893895155, -15.838693593738803],
           [-47.9286618250475, -15.836381563622275],
           [-47.9205937403307, -15.84265701235814],
           [-47.91046571909047, -15.841170739492236],
           [-47.89947939096547, -15.837042146356177],
           [-47.89089632211781, -15.834564949964893],
           [-47.884029867039686, -15.82267398451362],
           [-47.876305105076796, -15.819370814410107],
           [-47.87149858652211, -15.817223724907668],
           [-47.86102724252797, -15.814746285619405],
           [-47.855362417088514, -15.810286818439192],
           [-47.835510506741066, -15.817000056277438],
           [-47.831047310940285, -15.815678757638791],
           [-47.83070398818638, -15.809897974617622],
           [-47.830017342678566, -15.803456336136158],
           [-47.8372271205106, -15.801474252282995],
           [-47.83997370254185, -15.797344848600057],
           [-47.83791376601841, -15.794206445485116],
           [-47.8291590357938, -15.794701986052088],
           [-47.82435251723911, -15.790572444286857],
           [-47.83842875014927, -15.788920604011928],
           [-47.85319162856724, -15.787433936251015],
           [-47.85696817886021, -15.785451695604204],
           [-47.859543099514504, -15.780991583267634],
           [-47.85971476089146, -15.77520981012786],
           [-47.853019967190285, -15.771245070420761],
           [-47.85593821059849, -15.765132611567118],
           [-47.869499459377785, -15.757698291882333],
           [-47.87379099380161, -15.748115878344171],
           [-47.88203073989536, -15.73886346401771],
           [-47.892502083889504, -15.731758645767934]]],
         [[[-46.62506881806836, -10.414199781397379],
           [-46.63330856416211, -10.42399197333611],
           [-46.62300888154492, -10.446276503463835],
           [-46.61373916718945, -10.466871390804643],
           [-46.60858932588086, -10.489490428782155],
           [-46.604126130080076, -10.511432691750004],
           [-46.59897628877148, -10.525272394431145],
           [-46.60893264863476, -10.529322921661807],
           [-46.605156098341794, -10.555987563143594],
           [-46.61545578095898, -10.567125273325937],
           [-46.61682907197461, -10.592436748342895],
           [-46.605156098341794, -10.584674784738255],
           [-46.56361404511914, -10.587374620460498],
           [-46.53305832002148, -10.568137772412467],
           [-46.540954743361326, -10.545524498157688],
           [-46.53614822480664, -10.517508735210965],
           [-46.560180817580076, -10.486114557838796],
           [-46.61408248994336, -10.420615390189166]]]]),
    reg_1_2 = 
    /* color: #0f22ff */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-44.59470216288879, -5.993376821023321],
          [-44.58980981364562, -6.007802729704692],
          [-44.57830850138976, -6.009509912555551],
          [-44.57418862834289, -6.000034980162595],
          [-44.563030638840935, -5.992608566662968],
          [-44.55015603556945, -5.995766938783165],
          [-44.543289580491326, -5.995852299938081],
          [-44.5404571677716, -5.9941450743021845],
          [-44.53813973918273, -5.995510855238281],
          [-44.53427735820129, -5.994827965197597],
          [-44.531101622727654, -5.991584225833733],
          [-44.52500764384582, -5.991925672990397],
          [-44.52045861735656, -5.989364814110337],
          [-44.513592162278435, -5.987401480836141],
          [-44.50904313578918, -5.985352777722731],
          [-44.5034641410382, -5.987060030850719],
          [-44.49994508281066, -5.987316118359795],
          [-44.49496690287902, -5.9862064049535215],
          [-44.49179116740539, -5.986035679614047],
          [-44.48543969645812, -5.9879990177970965],
          [-44.477629103806755, -5.990218435071567],
          [-44.471878447678826, -5.9910720546983125],
          [-44.46372453227355, -5.9928646515699056],
          [-44.45934716716125, -5.993974351444802],
          [-44.44861833110168, -5.999096013925394],
          [-44.44329682841613, -6.002510428852976],
          [-44.43788949504211, -6.0032786692636195],
          [-44.43334046855285, -6.007802729704692],
          [-44.42484323039367, -6.014375354297283],
          [-44.41986505046203, -6.012753545218294],
          [-44.41505853190734, -6.008058807473625],
          [-44.40853539958312, -6.005412664720136],
          [-44.401754775193474, -6.009765989521355],
          [-44.39591828837707, -6.011985318177316],
          [-44.391712584641716, -6.008485603487526],
          [-44.38930932536437, -6.004217628294421],
          [-44.384502806809685, -6.004729787083629],
          [-44.37840882792785, -6.004559067540726],
          [-44.371027388718865, -6.006436979569494],
          [-44.36596337809875, -6.004644427318869],
          [-44.3606418754132, -6.004473707749214],
          [-44.36072770610168, -6.0085709626501425],
          [-44.35592118754699, -6.011217090051552],
          [-44.34699479594543, -6.013692487906083],
          [-44.3427032615216, -6.0139485629032645],
          [-44.33626595988586, -6.017875031091946],
          [-44.33197442546203, -6.021972185045658],
          [-44.32553712382629, -6.0251303867916945],
          [-44.31695405497863, -6.024191463867121],
          [-44.31180421367004, -6.028203214098072],
          [-44.31154672160461, -6.033153843704842],
          [-44.30596772685363, -6.034092751117456],
          [-44.29867211833312, -6.035629141557124],
          [-44.29377976908996, -6.032641711703464],
          [-44.29154817118957, -6.0298249770496275],
          [-44.28725663676574, -6.029056774150611],
          [-44.27558366313293, -6.0350316569036995],
          [-44.272922911790154, -6.03494630189943],
          [-44.26777307048156, -6.036141270735724],
          [-44.26133576884582, -6.035629141557124],
          [-44.256443419602654, -6.032556356322857],
          [-44.24854699626281, -6.020606470494186],
          [-44.24554292216613, -6.0145460707611145],
          [-44.24107972636535, -6.0145460707611145],
          [-44.236702361253045, -6.011899959550242],
          [-44.233698287156365, -6.009765989521355],
          [-44.23009339824035, -6.00575410321732],
          [-44.228462615159295, -6.000461782463053],
          [-44.22408525004699, -5.992011034746183],
          [-44.220737853196404, -5.984072334376438],
          [-44.21876374736144, -5.977413980637216],
          [-44.21687547221496, -5.970840910939534],
          [-44.21661798014953, -5.964950690567889],
          [-44.2163604880841, -5.95940187437052],
          [-44.2137855674298, -5.9550481485391655],
          [-44.213184752610466, -5.950694388198742],
          [-44.21035233989074, -5.947194281350555],
          [-44.204945006516716, -5.945743011002274],
          [-44.19885102763488, -5.942328242141473],
          [-44.19189874186828, -5.938828082074758],
          [-44.18734971537902, -5.9319984374256665],
          [-44.18434564128234, -5.927388379462529],
          [-44.18219987407043, -5.9217538118779665],
          [-44.18039742961242, -5.919363371899244],
          [-44.173015990403435, -5.916546054363944],
          [-44.16589204325988, -5.915777692544251],
          [-44.15859643473937, -5.91381409637683],
          [-44.156021514085076, -5.909886883132273],
          [-44.15421906962707, -5.906215767292452],
          [-44.14915505900695, -5.899897976093596],
          [-44.14769593730285, -5.899044215002978],
          [-44.143318572190545, -5.896739053493083],
          [-44.14014283671691, -5.894690012998327],
          [-44.137310423997185, -5.892555587771102],
          [-44.13293305888488, -5.8883720905230925],
          [-44.129585662034295, -5.884956967372113],
          [-44.126066603806755, -5.8808587918959025],
          [-44.12323419108703, -5.868478703529247],
          [-44.118856825974724, -5.866771083543117],
          [-44.11516610637023, -5.870783982212595],
          [-44.11276284709289, -5.873003871190118],
          [-44.10229150309875, -5.866429558918307],
          [-44.10031739726379, -5.861562810293146],
          [-44.099115767625115, -5.853707617735174],
          [-44.09482423320129, -5.848584606572518],
          [-44.09044686808898, -5.844144625609132],
          [-44.0914768363507, -5.836033031004702],
          [-44.09276429667785, -5.83005599143965],
          [-44.09430924907043, -5.825615863688105],
          [-44.095339217332146, -5.820663372088227],
          [-44.095081725266716, -5.816479336555576],
          [-44.09671250834777, -5.812295269898281],
          [-44.09817163005187, -5.808281952247377],
          [-44.10169068827941, -5.803670871135407],
          [-44.10615388408019, -5.799401317955503],
          [-44.10752717509582, -5.798376620383093],
          [-44.10975877299621, -5.801963053742643],
          [-44.11302033915832, -5.798547403441073],
          [-44.11825601115539, -5.800767578489973],
          [-44.12074510112121, -5.803243917272219],
          [-44.12417832866027, -5.800340622428449],
          [-44.133547213451905, -5.797864270898996],
          [-44.13569298066382, -5.800511404891843],
          [-44.13783874787573, -5.804439387274214],
          [-44.14213028229956, -5.803756261869226],
          [-44.145821001904054, -5.804268606000588],
          [-44.15139999665503, -5.801279925337146],
          [-44.153030779736085, -5.802731572209577],
          [-44.155176546948, -5.807940391977696],
          [-44.16032638825659, -5.804268606000588],
          [-44.17062607087378, -5.803927043298089],
          [-44.1745742825437, -5.810245919778282],
          [-44.178779986279054, -5.810502088951242],
          [-44.18307152070288, -5.81212449100656],
          [-44.18633308686499, -5.812636827526257],
          [-44.1895946530271, -5.8134907206893445],
          [-44.19534530915503, -5.814088445132598],
          [-44.19852104462866, -5.817760167066082],
          [-44.20161094941382, -5.820321819334401],
          [-44.204700854198975, -5.81946793654188],
          [-44.207447436230225, -5.8181017213762045],
          [-44.209421542065186, -5.8152838921142225],
          [-44.21285476960425, -5.81443000167224],
          [-44.21714630402808, -5.815881614652463],
          [-44.21834793366675, -5.81861405245237],
          [-44.226931002514405, -5.8140030559652915],
          [-44.230450060741944, -5.8176747784561345],
          [-44.23654403962378, -5.820577983919233],
          [-44.238174822704835, -5.822456520640222],
          [-44.23800316132788, -5.8287751889618775],
          [-44.24057808198218, -5.828604415077317],
          [-44.24529876984839, -5.829287510303751],
          [-44.247873690502686, -5.83022676488247],
          [-44.25654259003882, -5.835093786149054],
          [-44.266155627148194, -5.831422177526978],
          [-44.28598251618628, -5.818187109921319],
          [-44.287355807201905, -5.812636827526257],
          [-44.285381701366944, -5.8020484447351315],
          [-44.28100433625464, -5.798803577931106],
          [-44.28057518281226, -5.796156435925819],
          [-44.281090166943116, -5.790178972836146],
          [-44.28143348969702, -5.787190217573634],
          [-44.2789443997312, -5.789068865583683],
          [-44.27276459016089, -5.784372233853522],
          [-44.266670611279054, -5.781468842002718],
          [-44.26306572236304, -5.781639630171074],
          [-44.260147478954835, -5.778992407769863],
          [-44.259375002758546, -5.772246204406347],
          [-44.260662463085694, -5.769769729854083],
          [-44.26323738373999, -5.768317998363655],
          [-44.26332321442847, -5.764731351694328],
          [-44.26297989167456, -5.75977832617621],
          [-44.2679580716062, -5.757131001720658],
          [-44.27267875947241, -5.751580120088851],
          [-44.27654114045386, -5.748761959449456],
          [-44.282892611401124, -5.747224775036676],
          [-44.281605151073975, -5.744406592833629],
          [-44.28649750031714, -5.742527796950967],
          [-44.29199066437964, -5.740905195520938],
          [-44.295080569164796, -5.741417596471675],
          [-44.29817047394995, -5.739624191128667],
          [-44.31027260102515, -5.739880392237436],
          [-44.31370582856421, -5.739965792581441],
          [-44.3173965481687, -5.742271597032361],
          [-44.320829775707764, -5.746370781902636]]]);

// send mapping to pre-integration folder
// dhemerson.costa@ipam.org.br
           
var palette = require('users/mapbiomas/modules:Palettes.js').get('classification6');

// Defina seu asset de entrada
var assetInput = 'users/dh-conciani/collection7/0_sentinel/c1-general-post';
var file_name = 'CERRADO_sentinel_gapfill_freq_temporal_spatial_12';

// Carregue a sua coleção aqui
var collection = ee.Image(assetInput + '/' + file_name);

// Defina seu asset de saída
var assetOutput = 'projects/mapbiomas-workspace/COLECAO7-S2/classificacao';

// Defina a versão de saída
var outputVersion = '1';

// Defina o id de lançamento da coleção mapbiomas
var collectionId = 1;

// Se for bioma use este.
var theme = { 'type': 'biome', 'name': 'CERRADO' };

// Defina a fonte produto do dado
var source = 'ipam';

// set description
var descr = 'first version, without rocky';

// Todos os anos mapeados na coleção 6
var years = [
    '2016', '2017', '2018', '2019', '2020', '2021', '2022'
];

// Boundary box de todo o Brasil
var geometry = ee.Geometry.Polygon(
    [
        [
            [-75.46319738935682, 6.627809464162168],
            [-75.46319738935682, -34.62753178950752],
            [-32.92413488935683, -34.62753178950752],
            [-32.92413488935683, 6.627809464162168]
        ]
    ], null, false
);

// get hand
var hand = ee.ImageCollection("users/gena/global-hand/hand-100")
  .mosaic()
  .toInt16()
  .clip(geometry)
  .rename('hand')
  .gte(15);
  //Map.addLayer(hand.randomVisualizer());
  
var tree_canopy = ee.Image('users/nlang/ETH_GlobalCanopyHeight_2020_10m_v1');
//Map.addLayer(tree_canopy, {palette: ['red', 'orange', 'yellow', 'green'], min:0, max:30}, 'tree canopy', false);
  
// A digital elevation model.
var dem = ee.Image('NASA/NASADEM_HGT/001').select('elevation');
// Calculate slope. Units are degrees, range is [0,90).
var slope = ee.Terrain.slope(dem);
//Map.addLayer(slope, {palette:['green', 'yellow', 'orange', 'red'], min:0, max:5}, 'slope');

// mask 1
var wetland_to_savanna = ee.Image(1).clip(wetland_to_savanna);

// mask 2
var savanna_to_forest = ee.Image(1).clip(reg_1_2);
//Map.addLayer(savanna_to_forest);

years.forEach(
    function (year) {

        var imageYear = collection.select('classification_' + year);

        imageYear = imageYear.rename('classification');

        imageYear = imageYear
            .set('territory', 'BRAZIL')
            .set('biome', 'CERRADO')
            .set('year', parseInt(year, 10))
            .set('version', outputVersion)
            .set('collection', collectionId)
            .set('source', source)
            .set('description', descr);

        var vis = {
            'min': 0,
            'max': 49,
            'palette': palette,
            'format': 'png'
        };

       var name = year + '-' + outputVersion;

        if (theme.type === 'biome') {
            name = theme.name + '-' + name;
        }
        
        print(imageYear);
        Map.addLayer(imageYear, vis, theme.name + ' PRE-INT ' + year, false);
        
        // perform reclassification of mosaic of agriculture and pasture to pasture into protected areas (except APAs and TIs)
        // build mask
        // import protected areas
        var pa = ee.Image(1).clip(
                    ee.FeatureCollection('projects/mapbiomas-workspace/AUXILIAR/areas-protegidas')
                            .filterMetadata('categoria', 'not_equals', 'APA')
                            .filterMetadata('categoria', 'not_equals', ''));

        // remap mosaic of uses into PAs to pasture
        imageYear = imageYear.where(imageYear.eq(21).and(pa.eq(1)), 15)
          // remap wetland with hand greater to 15m and within PAs to grassland 
          .where(imageYear.eq(11).and(hand.eq(1).and(pa.eq(1))), 12)
          // remap wetland into mask to savanna (brasília)
          .where(imageYear.eq(11).and(wetland_to_savanna.eq(1)), 4)
          // remap savanna into mask and with tree heigth greater than x to forest (border betweens regions 1-2)
          .where(imageYear.eq(4).and(savanna_to_forest.eq(1).and(tree_canopy.gt(10))), 3);

        
        Map.addLayer(imageYear, vis, theme.name + ' ' + year, false);

        Export.image.toAsset({
            'image': imageYear,
            'description': name,
            'assetId': assetOutput + '/' + name,
            'pyramidingPolicy': {
                '.default': 'mode'
            },
            'region': geometry,
            'scale': 10,
            'maxPixels': 1e13
        });
    }
);
